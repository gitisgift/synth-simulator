#!/usr/bin/env python
#
# Co-ordinates and utility functions for simulating
# Whitelees windfarm near Ayr, Scotland
#
# Copyright (c) 2017 DevicePilot Ltd.
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
# 
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

import random
import device, sim
import wind

WPerTurbine = 1600000 # Whitelees produces about 500MW peak from about 300 turbines
cutInSpeed = 3.5   # Wind has to be at least this strong (m/s) for turbine to turn
fullPowerSpeed = 14
cutOutSpeed = 25
windScaling = 77    # Turn normalised speed into m/s (77m/s is the max ever wind speed seen in the UK - so far!)

def belowCutIn(windSpeed):
    return windSpeed < cutInSpeed

def aboveCutOut(windSpeed):
    return windSpeed > cutOutSpeed

def windspeedToPower(windSpeed):
    if belowCutIn(windSpeed) or aboveCutOut(windSpeed):
        return 0
    proportion = (windSpeed-cutInSpeed)/(fullPowerSpeed-cutInSpeed)
    proportion = min(1.0, proportion)
    return proportion * WPerTurbine

def windAndPower(epochSecs, hashObject=0):
    """hashObject can be anything, to add a bit of uniqueness to the reading a bit unique, e.g. device ID or location"""
    timeDither = abs(hash(hashObject)) % 300 # Add up to 5 minutes time dither
    strengthDither = 0.8 + 0.2 * (abs(hash(hashObject)) % 1000) / 1000.0    # Dither strength by 20%
    windSpeed = wind.windStrength(epochSecs + timeDither) * windScaling * strengthDither
    windSpeed = abs(windSpeed)
    return windSpeed, windspeedToPower(windSpeed)


def deviceSetup():
    """Set up devices."""
    for i in range(len(turbineCoordinates)):
        (longitude, latitude, _) = turbineCoordinates[i]
        props = {
            "$id" : "-".join([format(random.randrange(0,255),'02x') for _ in range(6)]), # A 6-byte MAC address 01-23-45-67-89-ab
            "label" : "Turbine "+str(i+1),
            "icon" : "turbine",
            "is_demo_device" : True,
            "longitude" : longitude,
            "latitude" : latitude,
            "parent" : "Gateway "+str(1 + int(i / 60)) # 6 gateways for 319 devices
            }
        d = device.device(props, autoTick=False)
        sim.injectEventDelta(sim.hours(1), tickDeviceHourly, d)

    # Set up gateways
    for i in range(len(gatewayCoordinates)):
        (longitude, latitude, commsrel) = gatewayCoordinates[i]
        props = {
            "$id" : "-".join([format(random.randrange(0,255),'02x') for _ in range(6)]), # A 6-byte MAC address 01-23-45-67-89-ab
            "label" : "Gateway "+str(i+1),
            "icon" : "cloud",
            "is_demo_device" : True,
            "longitude" : longitude,
            "latitude" : latitude
            }
        d = device.device(props, autoTick=False)
        d.setCommsReliability(sim.hours(24), commsrel)
        sim.injectEventDelta(sim.hours(1), tickGatewayHourly, d)

def tickDeviceHourly(d):
    """Propagate this device's gateway comms state to this device (i.e. if gateway is offline, then this device is offline)."""
    g = d.getProperty("parent")
    commsOK = device.getDeviceByProperty("label",g).getCommsOK()
    d.setCommsOK(commsOK)

    # Update performance stats
    (wind,power) = windAndPower(sim.getTime(), d)
    props = {
        "windspeed" : wind,
        "outputWatts" : power
    }
    d.setProperties(props)

    sim.injectEventDelta(sim.hours(1), tickDeviceHourly, d)

def tickGatewayHourly(d):
    d.setProperties({ "heartbeat" : 1 })
    sim.injectEventDelta(sim.hours(1), tickGatewayHourly, d)


if __name__ == "__main__":
    minWind = 1000000
    maxWind = 0
    minPower = 1000000
    maxPower = 0
    for time in range(0,60*60*24*365,300):
        w, p = windAndPower(time+10000000)
        print w,p
        minWind = min(minWind, w)
        maxWind = max(maxWind, w)
        minPower = min(minPower, p)
        maxPower = max(maxPower, p)
    print "Wind:",minWind, maxWind," Power:",minPower,maxPower


LWM2M_mapping = {   # Map Synth property names to LWM2M objectID/_/resourceID magic number pairs (see LWM2M.py)
    "$id" : (3,2),          # Device/Serial Number
    "firmware" : (3,3),     # Device/Firmware version
    "latitude" : (6,0),     # Location/Latitude
    "longitude" : (6,1)    # Location/Longitude
    }

gatewayCoordinates = [ # (longitude, latitude, comms_reliability)
(-4.32,55.66,0.80),
(-4.34,55.72,1.00),
(-4.33,55.67,0.99),
(-4.25,55.68,0.98),
(-4.23,55.69,0.99),
(-4.39,55.75,1.00)
]

turbineCoordinates = [ # (longitude, latitude, altitude=n/a)
(-4.363121360910497,55.7211469299052,0),    # 1
(-4.325124512049068,55.63628343371141,0),
(-4.34040035282158,55.64623066519115,0),
(-4.331758314493804,55.63384845761354,0),
(-4.334820757335801,55.64199483214338,0),
(-4.326215788358425,55.64757065882198,0),
(-4.318111669402656,55.63653529058389,0),
(-4.321499782843911,55.66399671430121,0),
(-4.328419972015841,55.64357537933062,0),
(-4.323549468858507,55.63933906760848,0),   # 10
(-4.340580345213691,55.63556282031495,0),
(-4.33763896239485,55.64404416154925,0),
(-4.343196971428442,55.64071081064638,0),
(-4.344112501030253,55.64240073503275,0),
(-4.330641162628069,55.63876624713618,0),
(-4.358868524187752,55.65184245973983,0),
(-4.353158973449944,55.64541061471368,0),
(-4.349524513556053,55.64094089519216,0),
(-4.334714875264101,55.6484662052382,0),
(-4.332175616264743,55.6463309101435,0),    # 20
(-4.331456792529428,55.65527932603607,0),
(-4.354499014349899,55.64172015349701,0),
(-4.357106941081657,55.64670592971693,0),
(-4.34784811060004,55.64713179251536,0),
(-4.346978508700301,55.64442959931017,0),
(-4.329996483151517,55.65115252636912,0),
(-4.34178291161582,55.64931312750933,0),
(-4.343237305897337,55.65212096361334,0),
(-4.337686889504441,55.654020178972,0),
(-4.354988860396974,55.65005434708387,0),   # 30
(-4.349355315463566,55.64994779486451,0),
(-4.336240166990583,55.65126467143753,0),
(-4.325176661457769,55.65419808189949,0),
(-4.362806379948674,55.65318297702969,0),
(-4.324645595098421,55.73358510763013,0),
(-4.372521926986205,55.65380453332674,0),
(-4.360938953701546,55.64865650447074,0),
(-4.365281674019748,55.64994687738733,0),
(-4.300806412512369,55.67633893699318,0),
(-4.332902230910235,55.65702016019904,0),   # 40
(-4.319679483579879,55.66028005095824,0),
(-4.369783780006542,55.6513518152711,0),
(-4.316279345979695,55.65645634325297,0),
(-4.327768620844661,55.65921899969445,0),
(-4.286801909665952,55.6834076790227,0),
(-4.314989865227171,55.66725967035981,0),
(-4.321919207798368,55.66918014420876,0),
(-4.309085048049434,55.67326065432814,0),
(-4.300562341507012,55.67189657355227,0),
(-4.316905348643991,55.67167144728392,0),   # 50
(-4.324238925766931,55.67403324636882,0),
(-4.330837580642802,55.66918144216938,0),
(-4.312606333127268,55.66268155249704,0),
(-4.307525445110271,55.66884149673891,0),
(-4.324276871078744,55.67859397986731,0),
(-4.316383113559104,55.68058304202123,0),
(-4.307244287824398,55.68742615925238,0),
(-4.308605504407259,55.67852595050091,0),
(-4.343167012355201,55.70923950447609,0),
(-4.290828203060979,55.67867067306209,0),   # 60
(-4.317405771083868,55.67625078008275,0),
(-4.322378859352048,55.68304198814701,0),
(-4.292238841800807,55.68223927147407,0),
(-4.301760980673874,55.68478836905504,0),
(-4.303133807530628,55.69548338199327,0),
(-4.295707386615594,55.68713161141309,0),
(-4.306214300451706,55.69194826636785,0),
(-4.308462904392123,55.69791052437527,0),
(-4.321643966727303,55.71884352603778,0),
(-4.298071205463256,55.69305566690261,0),   # 70
(-4.301434406768906,55.68974083211408,0),
(-4.31126447420707,55.69437314218654,0),
(-4.316133727894995,55.69644296554928,0),
(-4.317506707455449,55.69205983220447,0),
(-4.351272691888886,55.72011460031313,0),
(-4.321049185968249,55.69878895271878,0),
(-4.32103650772933,55.70819854781317,0),
(-4.333923846483692,55.70477883711104,0),
(-4.338687418247387,55.70208900248269,0),
(-4.322945255831305,55.6947406374407,0),    # 80
(-4.292294013859869,55.69739326500518,0),
(-4.328905386723699,55.70740284465175,0),
(-4.354439321879812,55.70497472476756,0),
(-4.326584339991807,55.69134040764144,0),
(-4.313286893423526,55.70006415223181,0),
(-4.322619811234674,55.70448221376429,0),
(-4.344027611538417,55.70454584222289,0),
(-4.349260553064218,55.70694224075432,0),
(-4.338407709507527,55.7070252161386,0),
(-4.338097431815557,55.71175523744516,0),   # 90
(-4.332975922398346,55.71364042991178,0),
(-4.352309479049401,55.71573652683913,0),
(-4.345438279777328,55.71869070095648,0),
(-4.316594082484384,55.71657374578989,0),
(-4.326979592402878,55.71602924612819,0),
(-4.321877673227975,55.71353653319889,0),
(-4.334219898243211,55.73633317077834,0),
(-4.402541307103492,55.70802962740399,0),
(-4.356868388044722,55.72062717083011,0),
(-4.323121815060842,55.74076045698513,0),   # 100
(-4.359680317538154,55.71717771797036,0),
(-4.362005188339778,55.72800640645763,0),
(-4.352750404581887,55.72869309973905,0),
(-4.358680993756209,55.72536539554598,0),
(-4.369253259885118,55.72620714326268,0),
(-4.341862080625387,55.72853450909831,0),
(-4.343256653932281,55.72292035409916,0),
(-4.376871960521568,55.72834171513098,0),
(-4.329416304122997,55.73575707432255,0),
(-4.431055817057388,55.71590824669656,0),   # 110
(-4.460630394087662,55.74754948151104,0),
(-4.322352904936211,55.73764930142646,0),
(-4.429359609430882,55.7103079473376,0),
(-4.428245770779979,55.70533916706044,0),
(-4.424215059523975,55.70609041162533,0),
(-4.427528512132573,55.70800231896799,0),
(-4.41999912039641,55.7134795660136,0),
(-4.420094555941716,55.70937529089323,0),
(-4.345042607304233,55.66986293136637,0),
(-4.430702602217651,55.71206080649413,0),   # 120
(-4.422955291097718,55.71092474690213,0),
(-4.416717205791009,55.71204583632342,0),
(-4.404494625698764,55.71002467965974,0),
(-4.425282538438717,55.71270931791784,0),
(-4.413730448884222,55.71838333932617,0),
(-4.418296286402129,55.71670434835421,0),
(-4.409676126800285,55.71061046912151,0),
(-4.41072741311089,55.7166838835935,0),
(-4.413707613943743,55.70822816544775,0),
(-4.338921858227266,55.67776543578655,0),   # 130
(-4.415229561642552,55.71515467254132,0),
(-4.403832923887629,55.71271190707095,0),
(-4.404030551337824,55.71634290485998,0),
(-4.40881143657876,55.71965610335332,0),
(-4.359941154993049,55.69721904078376,0),
(-4.408995303175518,55.70773637505441,0),
(-4.305562865532789,55.64973511614426,0),
(-4.34741418677286,55.67889329945073,0),
(-4.407463732850994,55.71375071259282,0),
(-4.367753324635713,55.69827112358328,0),   # 140
(-4.354909932301924,55.67821936385427,0),
(-4.346337423076104,55.67449619144116,0),
(-4.273538549311652,55.65415950011722,0),
(-4.33866249785126,55.67379359648002,0),
(-4.354470085058036,55.67373696973111,0),
(-4.350699410392992,55.68811255863782,0),
(-4.331979214450961,55.68116171226471,0),
(-4.339487120597357,55.68112741496595,0),
(-4.33935224673362,55.6871187239616,0),
(-4.331974285049753,55.67711854869774,0),   # 150
(-4.357040107151736,55.69070530469371,0),
(-4.337913528830077,55.66941954093448,0),
(-4.332658099631602,55.67265949485367,0),
(-4.354819816501542,55.69474761371659,0),
(-4.274720976546487,55.6620930037325,0),
(-4.350414708485762,55.6979009688319,0),
(-4.368957568659204,55.70266029144995,0),
(-4.374443148832048,55.69643852191501,0),
(-4.376339444977678,55.70032045009152,0),
(-4.361606643273688,55.70382222681439,0),   # 160
(-4.315498173958447,55.70574434926295,0),
(-4.356722286792546,55.70095561649268,0),
(-4.31656693170369,55.71121966144834,0),
(-4.31101506736516,55.7088129506337,0),
(-4.359027354382439,55.70779729098561,0),
(-4.305964393628631,55.71165214425287,0),
(-4.300632235189404,55.70894289266273,0),
(-4.308164387700937,55.70223404254585,0),
(-4.294321947109266,55.70595627000421,0),
(-4.306373043157517,55.70646202849704,0),   # 170
(-4.303421668416746,55.70014833051221,0),
(-4.296715751227104,55.70166595585352,0),
(-4.300933770463175,55.70401125358564,0),
(-4.276277811409942,55.65815312602803,0),
(-4.320136176730926,55.6446593947726,0),
(-4.244330783448637,55.68929271103754,0),
(-4.317882741090888,55.64751405202089,0),
(-4.290090665339883,55.65302214801083,0),
(-4.283146082269212,55.65523510049076,0),
(-4.282175803371585,55.65995400636983,0),   # 180
(-4.289188788558207,55.65753741007739,0),
(-4.313783314945495,55.65152341452699,0),
(-4.283709503881648,55.66851206448065,0),
(-4.286961920936276,55.66268536535539,0),
(-4.29370094992545,55.65974093839877,0),
(-4.279375969199268,55.65099747887511,0),
(-4.322104391064729,55.65072772843258,0),
(-4.279752977330502,55.66449604661603,0),
(-4.308625988699681,55.65797618545892,0),
(-4.296443002986161,55.65530715333979,0),   # 190
(-4.304963466020904,55.65417527215967,0),
(-4.301844651116569,55.65887229630567,0),
(-4.299376497261743,55.66703640920007,0),
(-4.267376492736403,55.68128495129432,0),
(-4.272893337070217,55.66596376945675,0),
(-4.239573291758958,55.67175732178573,0),
(-4.293189911597665,55.67001490109982,0),
(-4.29098232463772,55.6655743454707,0),
(-4.285810361682831,55.67216919713137,0),
(-4.273414477299648,55.6833606813654,0),    # 200
(-4.283854854930515,55.67641372864107,0),
(-4.29222419329391,55.6744791173613,0),
(-4.297590102908461,55.66303349485084,0),
(-4.255430405725338,55.67156269617321,0),
(-4.304872165522032,55.66371908888306,0),
(-4.255236980444196,55.68287418998853,0),
(-4.268087351226235,55.68520673746328,0),
(-4.256642136511059,55.69184301095129,0),
(-4.277489847948925,55.69178494448696,0),
(-4.250452797566746,55.69032112793005,0),   # 210
(-4.25107146153687,55.68608550146703,0),
(-4.248393705359845,55.68110665227564,0),
(-4.256854940884761,55.68711452811865,0),
(-4.242058752905823,55.66870379162324,0),
(-4.244426805990836,55.68477570163954,0),
(-4.263413167545746,55.68869374364406,0),
(-4.23331131262775,55.67417603250807,0),
(-4.248081056639692,55.67340194574314,0),
(-4.242656994081491,55.68038433858728,0),
(-4.243077193289789,55.67611944906261,0),   # 220
(-4.23538753124552,55.66729889952811,0),
(-4.21933010043259,55.68776563984124,0),
(-4.231489240263063,55.67042587656907,0),
(-4.248609178451074,55.66993980148945,0),
(-4.208425558415376,55.68991587344718,0),
(-4.238845687658338,55.68365125172548,0),
(-4.224952525651908,55.66901759655376,0),
(-4.229614131956996,55.67760401177974,0),
(-4.226044603699032,55.68902093929934,0),
(-4.243083304730683,55.66426284625015,0),   # 230
(-4.232218869666907,55.68205448170167,0),
(-4.226191428419204,55.68107967227317,0),
(-4.232478493431295,55.68675947471042,0),
(-4.244089954299625,55.66032802156845,0),
(-4.226517466439925,55.68558650349512,0),
(-4.238298915908631,55.68801682391206,0),
(-4.236035427001895,55.66308696477737,0),
(-4.213060275634676,55.68277250140145,0),
(-4.219248372324669,55.68398471552165,0),
(-4.228439738364912,55.66611878712119,0),   # 240
(-4.2312945436259,55.6987653123366,0),
(-4.237340508218681,55.69136670590497,0),
(-4.232091039355971,55.69046696923013,0),
(-4.237219347342089,55.65886861530007,0),
(-4.229736139041592,55.66192241838358,0),
(-4.235540418610798,55.67871743621566,0),
(-4.236581778607982,55.6957610849506,0),
(-4.216574109755218,55.69595982038361,0),
(-4.230012808400844,55.69468923566223,0),
(-4.254125402024766,55.67495688989998,0),   # 250
(-4.217456243575838,55.70000790881195,0),
(-4.224071213197863,55.69313943700448,0),
(-4.24245250189048,55.69704972669223,0),
(-4.215560435675493,55.69157013987852,0),
(-4.212603463660028,55.68640781359535,0),
(-4.198251475975497,55.67955324183171,0),
(-4.201803581117422,55.6890584228538,0),
(-4.2040563964668,55.69727766931506,0),
(-4.184720409181722,55.69185591506247,0),
(-4.20289735874643,55.7009620031824,0),     # 260
(-4.205472477397786,55.68501667818862,0),
(-4.224875713779985,55.69743769520251,0),
(-4.196480230279463,55.69170086768384,0),
(-4.210015297014848,55.69469363584263,0),
(-4.208803261519909,55.70205072693525,0),
(-4.203228921002571,55.69315462398859,0),
(-4.190153197204424,55.69044656510593,0),
(-4.196727690887129,55.69599223885797,0),
(-4.202721579231886,55.65930595119775,0),
(-4.196087834471887,55.68316044093155,0),   # 270
(-4.195258029415038,55.6875786126831,0),
(-4.207778371516494,55.66122803945077,0),
(-4.189250295330257,55.68613567629386,0),
(-4.189326297588964,55.68177500429783,0),
(-4.191934147486243,55.67856427171471,0),
(-4.212137502721685,55.66395249740276,0),
(-4.203230661150826,55.65521159154917,0),
(-4.209882066291634,55.6568760142949,0),
(-4.211651005692263,55.65254277970185,0),
(-4.208990560375963,55.64567021867513,0),   # 280
(-4.218019351890675,55.65351927691016,0),
(-4.196991671011499,55.65511812528948,0),
(-4.221882901989803,55.65603009429265,0),
(-4.233880023460737,55.65359811813716,0),
(-4.240114385755048,55.65483735044374,0),
(-4.230733167510167,55.65741640582688,0),
(-4.227311474707011,55.65236054554929,0),
(-4.217596023533986,55.64949184032876,0),
(-4.219455204526025,55.64584388269022,0),
(-4.21426153555764,55.64615466851532,0),    # 290
(-4.207958760820968,55.65090340826011,0),
(-4.199203268751192,55.64798409679859,0),
(-4.204607283597063,55.64847308932882,0),
(-4.21337302367616,55.64276309420012,0),
(-4.199489708796484,55.65104913254901,0),
(-4.218078925646913,55.64312185927966,0),
(-4.208248878059231,55.6425397885873,0),
(-4.203539931879473,55.64469243172059,0),
(-4.4375576247079,55.75008351952263,0),
(-4.446161232455247,55.7350916539374,0),    # 300
(-4.4151232031356,55.74699837146967,0),
(-4.419858334024259,55.74515444062921,0),
(-4.424796309327304,55.74107821011865,0),
(-4.426051081393214,55.73858696994036,0),
(-4.429878063562138,55.73667938847689,0),
(-4.434455098599507,55.73621509668669,0),
(-4.43906958469456,55.73673309457654,0),
(-4.40878792229512,55.75918272145795,0),
(-4.402892512056712,55.75897916879914,0),
(-4.399112399475279,55.75645302270934,0),   # 310
(-4.386578691339345,55.7518198319904,0),
(-4.388896068318445,55.75354490068294,0),
(-4.385631974420235,55.75672734246987,0),
(-4.400659689841982,55.73885970355056,0),
(-4.395448383929891,55.73862017611222,0),
(-4.400411652692222,55.7366073788147,0),
(-4.274294300633835,55.71287577535518,0),
(-4.275549769323225,55.716385928269,0),
(-4.384850698380353,55.73566016051677,0)    # 319
]
